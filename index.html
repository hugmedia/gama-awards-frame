<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAMA Awards Frame</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Prompt', sans-serif;
      background-color: white;
      min-height: 100vh;
      color: #333;
    }

    .frame-option {
      transition: all 0.3s ease;
      cursor: pointer;
      background-color: white;
      border: 1px solid #e5e7eb;
    }

    .frame-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .frame-option.selected {
      border: 3px solid #4500b2;
      transform: translateY(-5px);
    }

    .image-container {
      position: relative;
      width: 600px; /* Base size for preview */
      height: 600px;
      overflow: hidden;
      margin: 0 auto;
      background-color: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
    }

@media (max-width: 640px) {
    .frame-option {
        width: 96px; /* เท่ากับขนาดเริ่มต้น แต่ปรับให้เล็กลงได้ตามต้องการ */
        height: 96px; /* รักษาอัตราส่วน 1:1 */
        padding: 8px; /* เท่ากับขนาดเริ่มต้น */
        display: flex; /* จัดเรียงเนื้อหาภายใน */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-sizing: border-box; /* ให้ padding อยู่ภายในขนาดที่กำหนด */
    }
    .frame-option img {
        max-width: 64px; /* ป้องกันไม่ให้ภาพใหญ่เกินไป */
        max-height: 64px; /* รักษาอัตราส่วนภาพ */
        width: auto; /* ให้ความกว้างปรับตามสัดส่วน */
        height: auto; /* ให้ความสูงปรับตามสัดส่วน */
        object-fit: contain; /* แสดงภาพทั้งหมดโดยไม่ให้ถูกครอบตัด */
        flex-shrink: 0; /* ไม่ให้ภาพย่อเล็กลง */
    }
    .frame-option p {
        font-size: 0.875rem; /* เท่ากับขนาดเริ่มต้น */
        margin-top: 4px;
        line-height: 1.1; /* ปรับปรุงบรรทัด */
        text-align: center; /* จัดข้อความให้อยู่ตรงกลาง */
    }
}

    /* user-image and frame-image styles for preview */
    .user-image {
      position: absolute;
      transform-origin: center;
      width: 100%; 
      height: 100%;
      object-fit: cover; /* This makes the image cover the area, cropping as needed */
      left: 0;
      top: 0;
      /* Initial transform will be applied via JS */
    }

    .frame-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* Allows clicks to pass through */
      z-index: 10; /* Ensures frame is on top of user image */
    }

    .slider {
      -webkit-appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4500b2;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4500b2;
      cursor: pointer;
    }

    .btn {
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      font-size: 24px;
    }

    .spinner {
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 5px solid white;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type=file] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      cursor: pointer;
      display: block;
    }

    .header-gradient {
      background: linear-gradient(to right, #4500b2, #d83361);
      height: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="header-gradient"></div>
  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-center mb-6">
      <img src="https://hugmediacreation.com/wp-content/uploads/2025/06/logo-gama-awards.png" alt="GAMA Awards Logo" class="h-24">
    </div>
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">GAMA Awards Frame</h1>
    <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">เปลี่ยนรูปโปรไฟล์ของคุณให้โดดเด่นด้วยกรอบรูปภาพพิเศษจาก GAMA Awards อัพโหลดรูปภาพของคุณ เลือกกรอบที่ชอบ และดาวน์โหลดเพื่อใช้เป็นรูปโปรไฟล์ใหม่ของคุณ</p>
    
    <div class="mb-8 max-w-xl mx-auto">
      <div class="card p-6">
        <label class="block text-lg font-medium mb-3 text-gray-700">อัพโหลดรูปโปรไฟล์ของคุณ:</label>
        <div class="file-upload">
          <button id="uploadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
            </svg>
            เลือกรูปภาพจากเครื่อง
          </button>
          <input type="file" id="imageUpload" accept="image/*">
        </div>
        <p id="selectedFileName" class="mt-2 text-center text-sm text-gray-500"></p>
      </div>
    </div>
    
    <div class="mb-8">
      <h2 class="text-xl font-medium mb-4 text-center text-gray-700">เลือกกรอบรูปภาพ</h2>
      <div class="flex flex-wrap justify-center gap-3">
        <div class="frame-option rounded-lg p-2 text-center" data-frame="MAA">
          <img src="./MASTER MULTILINE Award.png" alt="MAA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">MAA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="MFA">
          <img src="./MASTER FIRM Award.png" alt="MFA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1  text-gray-800">MFA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="MMA">
          <img src="./MASTER AGENCY Award.png" alt="MMA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">MMA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="IMA">
          <img src="./International Management Award.png" alt="IMA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">IMA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="FLA">
          <img src="./Frontline Leader Awards.png" alt="FLA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">FLA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="ERA">
          <img src="./Excellence Recruitment Award.png" alt="ERA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">ERA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="COE">
          <img src="./Circle of Excellence Award.png" alt="COE" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">COE</p>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-2">
        <div class="card p-4">
          <div id="preview" class="image-container flex items-center justify-center">
            <div id="placeholderText" class="text-center p-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-gray-500">โปรดอัพโหลดรูปภาพและเลือกกรอบ</p>
            </div>
            <img id="userImage" class="user-image hidden" src="" alt="User uploaded image">
            <img id="frameImage" class="frame-image hidden" src="" alt="Selected frame">
          </div>
        </div>
      </div>
      
      <div class="card p-6">
        <h3 class="text-lg font-medium mb-4 text-gray-700">ปรับแต่งรูปภาพ</h3>
        
        <div class="mb-4">
          <label for="scaleSlider" class="block text-sm font-medium mb-1 text-gray-600">ขนาด:</label>
          <input type="range" id="scaleSlider" class="slider w-full" min="50" max="200" value="100">
          <div class="flex justify-between text-xs text-gray-500">
            <span>เล็ก</span>
            <span>ใหญ่</span>
          </div>
        </div>
        
        <div class="mb-4">
          <label for="xPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวนอน:</label>
          <input type="range" id="xPosSlider" class="slider w-full" min="-100" max="100" value="0">
          <div class="flex justify-between text-xs text-gray-500">
            <span>ซ้าย</span>
            <span>ขวา</span>
          </div>
        </div>
        
        <div class="mb-6">
          <label for="yPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวตั้ง:</label>
          <input type="range" id="yPosSlider" class="slider w-full" min="-100" max="100" value="0">
          <div class="flex justify-between text-xs text-gray-500">
            <span>บน</span>
            <span>ล่าง</span>
          </div>
        </div>
        
        <button id="downloadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mb-3" disabled>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
          </svg>
          ดาวน์โหลดรูปโปรไฟล์
        </button>
        
        <p class="mt-4 text-sm text-gray-500 text-center">ดาวน์โหลดและใช้เป็นรูปโปรไฟล์ของคุณบนโซเชียลมีเดีย</p>
      </div>
    </div>
    
    <div class="text-center text-sm text-gray-500 mb-8">
      © GAMA Awards 2025 - ระบบใส่กรอบรูปภาพ
    </div>
  </div>
  
  <div id="loadingOverlay" class="loading hidden">
    <div class="spinner"></div>
    <span>กำลังประมวลผล...</span>
  </div>

  // Download functionality using html2canvas
      downloadBtn.addEventListener('click', async function() {
        if (!userImageLoaded || !selectedFrame || !frameImageLoaded) {
          alert('โปรดอัปโหลดรูปภาพและเลือกกรอบก่อนดาวน์โหลด');
          return;
        }

        loadingOverlay.classList.remove('hidden');
        document.querySelector('#loadingOverlay p').textContent = 'กำลังเตรียมรูปภาพ...'; // Update loading text

        // Use a temporary div to render the full-resolution image
        // กำหนดขนาดให้ใหญ่ขึ้นเพื่อให้ได้ภาพที่มีคุณภาพสูงสำหรับดาวน์โหลด (เช่น 2000x2000 หรือ 2500x2500)
        // 1920x1920 คือขนาดที่ดีสำหรับโปรไฟล์ทั่วไป แต่ถ้าอยากได้ใหญ่ขึ้นสำหรับพิมพ์ อาจลอง 2500x2500
        const outputResolution = 2000; // ลองเปลี่ยนเป็น 2000 หรือ 2500
        
        const tempRenderDiv = document.createElement('div');
        tempRenderDiv.style.width = `${outputResolution}px`;
        tempRenderDiv.style.height = `${outputResolution}px`;
        tempRenderDiv.style.position = 'absolute'; 
        tempRenderDiv.style.left = '-9999px'; // ซ่อนออกจากหน้าจอ
        tempRenderDiv.style.top = '-9999px';
        tempRenderDiv.style.overflow = 'hidden'; 
        tempRenderDiv.style.backgroundColor = 'transparent'; 
        document.body.appendChild(tempRenderDiv);

        // Create new image elements for the high-res render
        const hiResUserImage = new Image();
        const hiResFrameImage = new Image();

        // **สำคัญ:** ตั้งค่า crossOrigin = 'anonymous'; สำหรับรูปภาพผู้ใช้
        // แม้ว่าตอนนี้จะใช้ไฟล์ในเครื่อง แต่ถ้าในอนาคตมีรูปจากต่างโดเมน (เช่น CDN) ตัวนี้จะช่วยเรื่อง CORS
        // และบางครั้ง html2canvas ก็ต้องการมันแม้จะเป็น local file สำหรับบางเบราว์เซอร์
        hiResUserImage.crossOrigin = 'anonymous'; 
        hiResFrameImage.crossOrigin = 'anonymous'; // อาจไม่จำเป็นสำหรับกรอบที่อยู่เครื่อง แต่ใส่ไว้เผื่ออนาคต

        // Set src *before* attaching onload/onerror to avoid race conditions
        hiResUserImage.src = userImagePreview.src;
        hiResFrameImage.src = frameImagePreview.src;

        // คำนวณ scale factor จากขนาด preview (600px) ไปยังขนาด outputResolution
        const previewSize = 600;
        const scaleFactor = outputResolution / previewSize; 

        const currentScale = parseFloat(scaleSlider.value) / 100;
        const currentXPos = parseFloat(xPosSlider.value);
        const currentYPos = parseFloat(yPosSlider.value);

        // Apply transformations to high-res image proportionally
        // ตำแหน่ง (X, Y) และ Scale จะต้องถูกปรับตาม scaleFactor ใหม่
        hiResUserImage.style.transform = `translate(${currentXPos * scaleFactor}px, ${currentYPos * scaleFactor}px) scale(${currentScale})`;
        hiResUserImage.style.transformOrigin = 'center center'; 
        hiResUserImage.style.objectFit = 'cover'; 
        hiResUserImage.style.position = 'absolute'; 
        hiResUserImage.style.width = '100%'; 
        hiResUserImage.style.height = '100%';
        hiResUserImage.style.left = '0';
        hiResUserImage.style.top = '0';
        
        hiResFrameImage.style.position = 'absolute'; 
        hiResFrameImage.style.width = '100%'; 
        hiResFrameImage.style.height = '100%';
        hiResFrameImage.style.left = '0';
        hiResFrameImage.style.top = '0';
        hiResFrameImage.style.zIndex = '10'; 

        tempRenderDiv.appendChild(hiResUserImage);
        tempRenderDiv.appendChild(hiResFrameImage);

        try {
            document.querySelector('#loadingOverlay p').textContent = 'กำลังโหลดรูปภาพต้นฉบับ...';
            await Promise.all([
                new Promise((resolve, reject) => {
                    if (hiResUserImage.complete && hiResUserImage.naturalWidth > 0) {
                        console.log('High-res user image already complete.');
                        resolve();
                    } else {
                        hiResUserImage.onload = () => {
                            console.log('High-res user image loaded.');
                            resolve();
                        };
                        hiResUserImage.onerror = (e) => {
                            console.error('User image failed to load for high-res render:', e);
                            reject(new Error('รูปภาพผู้ใช้โหลดไม่สำเร็จ'));
                        };
                    }
                }),
                new Promise((resolve, reject) => {
                    if (hiResFrameImage.complete && hiResFrameImage.naturalWidth > 0) {
                        console.log('High-res frame image already complete.');
                        resolve();
                    } else {
                        hiResFrameImage.onload = () => {
                            console.log('High-res frame image loaded.');
                            resolve();
                        };
                        hiResFrameImage.onerror = (e) => {
                            console.error('Frame image failed to load for high-res render:', e);
                            reject(new Error('รูปภาพกรอบโหลดไม่สำเร็จ'));
                        };
                    }
                })
            ]);
            console.log('High-res images loaded in temp div.');

            document.querySelector('#loadingOverlay p').textContent = 'กำลังสร้างรูปภาพสุดท้าย...';
            const canvas = await html2canvas(tempRenderDiv, {
                width: outputResolution,
                height: outputResolution,
                scale: 1, // สำคัญ: กำหนด scale เป็น 1 เพื่อให้ html2canvas ใช้ resolution ที่เรากำหนดไว้
                backgroundColor: null, 
                useCORS: true, // ตั้งเป็น true เพื่อให้ html2canvas จัดการ CORS ให้
                allowTaint: true, // ตั้งเป็น true เพื่ออนุญาตให้รูปภาพที่มี CORS issues ถูก render ได้ (แต่จะไม่สามารถอ่าน pixel ได้)
                logging: true,
                imageTimeout: 20000, // เพิ่ม timeout เผื่อเน็ตช้า (20 วินาที)
                // เพิ่มการปรับปรุงคุณภาพการ render
                dpi: window.devicePixelRatio * 2, // เพิ่ม DPI สำหรับหน้าจอละเอียด
                letterRendering: true, // ปรับปรุงการ render ข้อความ
                // Remove the hidden tempRenderDiv after capture
                onclone: (document) => {
                    document.body.removeChild(tempRenderDiv); // This might cause issues, better remove after .then
                }
            });
            
            // ลบ tempRenderDiv หลังจาก html2canvas ทำงานเสร็จ
            if (document.body.contains(tempRenderDiv)) {
                document.body.removeChild(tempRenderDiv); 
            }
            console.log('html2canvas rendering complete.');

            try {
                const link = document.createElement('a');
                link.download = `profile-${selectedFrame}-gama-awards.png`;
                // ใช้ canvas.toDataURL โดยระบุ quality ให้เหมาะสม (เช่น 0.9 หรือ 1.0)
                link.href = canvas.toDataURL('image/png', 0.9); 
                document.body.appendChild(link); 
                link.click();
                document.body.removeChild(link); 
                console.log('Image download initiated successfully.');
            } catch (e) {
                console.error('Error creating data URL or download link:', e);
                alert('ไม่สามารถดาวน์โหลดรูปภาพได้ (อาจเกิดจากปัญหาภายในหรือรูปภาพต้นฉบับเสียหาย)');
            }
            
        } catch (err) {
            console.error('Error during high-res image loading or html2canvas rendering:', err);
            alert(`เกิดข้อผิดพลาดในการสร้างรูปภาพ: ${err.message || 'กรุณาลองใหม่อีกครั้ง'}\n(หากเกิดบ่อย ลองเลือกรูปภาพที่มีขนาดเล็กลง)`);
            if (document.body.contains(tempRenderDiv)) {
                document.body.removeChild(tempRenderDiv); // Clean up temp div on error
            }
        } finally {
            loadingOverlay.classList.add('hidden');
            document.querySelector('#loadingOverlay p').textContent = 'กำลังประมวลผล...'; // Reset loading text
        }
      });
